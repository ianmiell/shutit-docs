# ShutIt User Guide

## Design goals

ShutIt was built originally to facilitate the deployment of complex Docker containers, so that developers can quickly prototype builds in a structured and flexible way with as shallow a learning curve as possible.

A ShutIt build is a programmable way of managing builds by modelling shell interactions.


## Key concepts
	
### Build

A ShutIt build consists of all the modules available going through the ShutIt Build lifecycle. This results in a container in a state from which it can be tagged, saved, exported, and/or pushed depending on your configuration.

### Module

A ShutIt module is a directory containing the configuration for the setup of a discrete unit of configuration.

This can be as simple as an apt-get install, a sequence of steps to get your package configured correctly, or a series of steps to set up networking for the a build, or anything else you deem useful to encapsulate as part of your build.

A module must inherit from ShutItModule and implement, as a mimimum, "is_installed" and "build" methods.

Each module has several attributes whose implications should be understood as they handle build order and dependency management:

#### module_id

A string - which should be globally unique - that represents this module's place in the ShutIt universe. By convention this follows the Java namespacing model of domain_name.namespace.module, eg

com.openbet.web.application

#### run_order

A float which represents the order in which this should be run in the ShutIt universe. 

The integer part should be a hash (in shutit_util.get_hash(string))of the domain used within themodule_id, eg com.openbet hashes to 1003189494. This is autogenerated by the "shutit skeleton" command (see below), which takes the domain as an argument.

The decimal part should be the order in which this module should be run within that ShutIt domain. 

This allows you to define a specific build order that is predictable.

#### description

Free text description of the module's purpose.

#### depends

List of module_ids of modules that are pre-requisites of this module.

#### conflicts

List of module_ids of modules that conflict with this module.


 

### ShutIt Build Lifecycle

#### Details

- Gather modules

Searches the modules directories given in the -m/--shutit_modules_dir argument for valid .py files to consider as part of the build.

- Gather configuration

Configuration is gathered in the following order:

1) Defaults loaded within the code

2) The following (auto-created) file is searched for: ~/.shutit/config 

This file can contain host-specific overrides, and is optional

3) configs/build.cnf is loaded from the current working directory of the shutit invocation

4) 0-n config files passed in with --config arguments are loaded

5) Command-line overrides, eg "-s com.mycorp.mymodule.module name value"

All config files need to have permissions 0x00.

- Check for conflicts

Module dependencies are checked to see whether there are any marked conflicts

- Check ready on all modules

Allows modules to determine whether the install can go ahead, eg are the requisite files in place?

- Record configuration

Gets the configuration and places it in the container in case it's useful later. Passwords are obfuscated with a repeated SHA-1 hash.

- Remove modules configured for removal

If you start with a full build image and want to test the rebuild of a module, then you can configure modules for removal as part of the build and they will be removed before being built.

- Build modules

Builds the module given the commands that are programmed.

At the end of each module, each module can be configured to tag, export, save, or push the resulting container.

- Test modules

Modules are tested using the test hooks for each module.

- Finalize modules

There's a final cleanup function that's run on each module before the end

- Finalize container

The container is finalized by the core setup module. As part of this it will tag, export, save, or push the resulting image depending on configuration.



#### Module hook functions

These all return True if OK (or the answer is "yes" for is\_installed), or False if not OK (or the answer is "no" for is\_installed).

If False is returned for all functions (except is\_installed), the build will fail.

- is\_installed

Used by "Check ready" part of lifecycle to determine whether the module is installed or not.

- remove

Handles the removal of the module. Useful for quick test of a recently-changed module.

- build

Handles the building of the module

- start

Handles the starting of the module. When tests are run all modules that have been built or are installed are started up.

- stop

Handles the stopping of the module. When any kind of persistence is performed, all modules that have been built or are installed are stopped first, then started again once done.

- test

Handles the testing of the module.

- get\_config

Gathers configuration for the module.


#### Module dependencies

Module conflicts

	


	
## Help

General help:

```
$ shutit -h
```

Build:

```
$ shutit build -h
```

Create new skeleton module:

```
$ shutit skeleton -h
```

Show computed configuration:

```
$ shutit list_configs -h
```

Show computed dependencies:

```
$ shutit list_deps -h
```

Show available modules:

```
$ shutit list_modules -h
```



### Introduction

The shutit object represents a build with an associated config. In theory multiple builds could be represented within one run, but this is functionality yet to be implemented. 

Calling methods on the object effect and affect the build in various ways and help manage the build process for you.

### Configuration

Configuration is specified in .cnf files.

Default config is shown [here](https://github.com/ianmiell/shutit/blob/master/shutit_util.py#L55)


Directory Structure
-------------------
Each module directory should contain modules that are grouped together somehow
and all/most often built as an atomic unit.
This grouping is left to the user to decide, but generally speaking a module
will have one relatively simple .py file.

Each module .py file should represent a single unit of build. Again, this unit's
scope is for the user to decide, but it's best that each module doesn't get too
large.

Within each module directory the following directories are placed as part of
`./shutit skeleton`.

- configs
    - default configuration files are placed here.
- context
    - equivalent to dockerfile context

These config files are also created, defaulted, and automatically sourced:

```
configs/build.cnf                  - 
```

And these files are also automatically created:

```
configs/README.md                  - README for filling out if required
run.sh                             - Script to run modules built with build.sh
build.sh                           - Script to build the module
```

